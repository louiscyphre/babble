!function(e,t,s,a,n,r,o){"use strict"
e.Babble={counter:0,apiUrl:"http://localhost:9000/",messages:[],myMessagesIds:[],stats:{users:0,messages:0},storage:a,run:function(e,t,s){t.Babble.updateKey("all",""),t.Babble.getStats(t.Babble.updateStats),e.querySelector(".Chat-sendMessageForm").addEventListener("submit",function(s){s.preventDefault()
var a=JSON.parse(t.Babble.storage.getItem("babble")),n=e.querySelector(".Chat-sendMessageFormText"),r={name:a.userInfo.name,email:a.userInfo.email,message:n.value,timestamp:t.Date.now()}
t.Babble.postMessage(r,t.Babble.storeId)})
var a=e.querySelector(".Modal")
a.addEventListener("submit",function(e){e.preventDefault(),t.Babble.register({name:a.elements[0].value,email:a.elements[1].value}),a.style.display="none",a.style.visibility="hidden",a.setAttribute("aria-hidden","true")}),t.onbeforeunload=function(){var e=JSON.parse(t.Babble.storage.getItem("babble")).userInfo
t.Babble.request("POST","logout",e).then(function(e){s.log("Answer on POST /logout:",e),t.Babble.updateKey("all","")}).catch(function(e){s.log(e)})}},poll:function t(a,r){var o=new n
o.addEventListener("load",function(){o.status>=200&&o.status<400?(s.log("Poll response from server:",o.responseText),""!==o.responseText&&r(JSON.parse(o.responseText)),t(a,r)):s.log("Server error")}),o.onerror=function(){s.log("Network error")}
var l
l="messages?counter="===a?e.Babble.apiUrl+a+e.Babble.counter.toString():e.Babble.apiUrl+a,o.open("GET",l,!0),o.setRequestHeader("Content-Type","text/plain"),s.log("poll URL:",l),o.send()},register:function(t){e.Babble.updateKey("userInfo",t),e.Babble.request("POST","login",t).then(function(t){e.Babble.getMessages(e.Babble.counter,e.Babble.storeMessages)}).catch(function(e){s.log(e)})},postMessage:function(t,a){a({id:"42"}),e.Babble.updateKey("currentMessage",t.message),e.Babble.request("POST","messages",t).then(function(e){a(e)}).catch(function(e){s.log(e)})},getMessages:function(t,s){s([]),e.Babble.poll("messages?counter=",s)},deleteMessage:function(t,a){a&&a(!0)
var n="messages/"+t.toString()
e.Babble.request("DELETE",n).then(function(e){a(e)}).catch(function(e){s.log(e)})},getStats:function(t){e.Babble.poll("stats",t)},request:function(t,a,o){return new r(function(r,l){var b=new n
b.onload=function(){b.status>=200&&b.status<400?r(JSON.parse(b.responseText)):(s.log("Server error"),l(JSON.parse(b.responseText)))},b.onerror=function(){s.log("Network error")},b.open(t,e.Babble.apiUrl+a,!0),b.setRequestHeader("Content-Type","text/plain"),s.log("request: URL:",e.Babble.apiUrl+a),"POST"===t?(s.log("POSTing: ",JSON.stringify(o)),b.send(JSON.stringify(o))):b.send()})},storeMessages:function(t){e.Babble.messages=e.Babble.messages.concat(t),e.Babble.counter=e.Babble.messages.length,s.log("Messages on client:",e.Babble.messages)},updateStats:function(e){},storeId:function(e){},updateKey:function(t,s){if("all"===t)return void e.Babble.storage.setItem("babble",JSON.stringify({currentMessage:s,userInfo:{name:s,email:s}}))
var a=JSON.parse(e.Babble.storage.getItem("babble"))
if("userInfo"===t)return a.userInfo.name=s.name,a.userInfo.email=s.email,void e.Babble.storage.setItem("babble",JSON.stringify(a))
if("currentMessage"===t)return a.currentMessage=s,void e.Babble.storage.setItem("babble",JSON.stringify(a))
throw new e.Babble.exception("wrong use of updateKey()")},exception:function(e){s.error("[CRITICAL ERROR] Exception thrown: ",e)}},e.Babble.run(t,e,s)}(this.window,this.document,this.console,this.localStorage,this.XMLHttpRequest,this.Promise,this.navigator)
