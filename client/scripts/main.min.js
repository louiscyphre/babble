!function(e,t,a,s,r,n,l){"use strict"
function o(a){a.preventDefault()
var s=JSON.parse(e.Babble.storage.getItem("babble")),r=t.querySelector(".Chat-msgFormText"),n={name:s.userInfo.name,email:s.userInfo.email,message:r.value,timestamp:e.Date.now()}
r.value="",e.Babble.postMessage(n,e.Babble.dummy)}function i(t){t.preventDefault(),e.Babble.register({name:t.target.elements[0].value,email:t.target.elements[1].value}),t.target.classList.add("hidden"),t.target.setAttribute("aria-hidden","true")}function b(s){s.preventDefault()
var r=s.target.parentNode.parentNode.parentNode.id
a.log("deleteMessageFromServer():Message id is:",r)
var n=t.getElementById(r)
n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),e.Babble.deleteMessage(r,e.Babble.decreaseCounter)}e.Babble={apiServerUrl:"http://localhost:9000",anonymousAvatar:"images/anon.svg",deleteMessageImg:"images/del_msg.svg",messages:[],messagesCounter:0,stats:{users:0,messages:0},storage:s,gravatar:"",run:function(e,t,a){t.Babble.updateKeyInLocalStorage("allKeys",""),t.Babble.getStats(t.Babble.updateStats),e.querySelector(".Chat-msgForm").onsubmit=o,e.querySelector(".Modal").onsubmit=i,t.onbeforeunload=function(){var e=JSON.parse(t.Babble.storage.getItem("babble")).userInfo
t.Babble.request("POST","/logout",e).then(function(e){a.log("Answer on POST /logout:",e),t.Babble.updateKeyInLocalStorage("all","")}).catch(function(e){a.log(e)})}},request:function(t,s,l){return new n(function(n,o){var i=new r
i.onload=function(){i.status>=200&&i.status<400?n(i.responseText):o(i.responseText)},i.onerror=function(){a.log("Network error")}
var b
b="/messages?counter="===s?e.Babble.apiServerUrl+s+e.Babble.messagesCounter.toString():e.Babble.apiServerUrl+s,i.open(t,b,!0),i.setRequestHeader("Content-Type","text/plain"),a.log("request: URL: ",t+" "+b),"POST"===t?(a.log("POSTing: ",JSON.stringify(l)),i.send(JSON.stringify(l))):i.send()})},poll:function t(s,r){e.Babble.request("GET",s).then(function(e){""!==e&&r(JSON.parse(e)),t(s,r)}).catch(function(e){a.log(e)})},register:function(t){e.Babble.updateKeyInLocalStorage("userInfo",t),e.Babble.request("POST","/login",t).then(function(t){e.Babble.gravatar=JSON.parse(t).gravatar,e.Babble.getMessages(e.Babble.messagesCounter,e.Babble.storeMessages)}).catch(function(e){a.log(e)})},postMessage:function(t,s){e.Babble.updateKeyInLocalStorage("currentMessage",t.message),e.Babble.request("POST","/messages",t).then(function(e){s(e)}).catch(function(e){a.log(e)})},getMessages:function(t,a){e.Babble.poll("/messages?counter=",a)},deleteMessage:function(t,s){e.Babble.request("DELETE","/messages/"+t).then(s(!0)).catch(function(e){a.log(e)})},getStats:function(t){e.Babble.poll("/stats",t)},storeMessages:function(t){e.Babble.messages=e.Babble.messages.concat(t),e.Babble.messagesCounter=e.Babble.messages.length,e.Babble.appendToListView([].concat(t))},appendToListView:function(a){for(var s=t.querySelector(".Chat-msgs-list"),r=0;r<a.length;++r)s.appendChild(e.Babble.createMessageHTML(a[r]))},decreaseCounter:function(t){t&&--e.Babble.messagesCounter},dummy:function(e){},createMessageHTML:function(a){var s=t.createElement("li")
return s.classList.add("Chat-msg"),s.setAttribute("tabindex","-1"),s.id=a.timestamp,s.appendChild(e.Babble.createAvatarHTML(a)),s.appendChild(e.Babble.createArticleHTML(a)),s},createAvatarHTML:function(a){var s=t.createElement("img")
return s.classList.add("Chat-msg-avatar"),"none"!==a.url?s.setAttribute("src",a.url):s.setAttribute("src",e.Babble.anonymousAvatar),s.setAttribute("alt",""),s.setAttribute("tabindex","-1"),s},createMessageTimeHTML:function(e){var a=new Date(parseInt(e.timestamp)),s=a.getHours(),r="0"+a.getMinutes(),n=s+":"+r.substr(-2),l=t.createElement("time")
return l.setAttribute("tabindex","0"),l.setAttribute("aria-label","Posted at:"),l.setAttribute("datetime",a.toISOString()),l.innerHTML=n,l},createHeaderHTML:function(a){var s=t.createElement("header")
s.setAttribute("tabindex","-1")
var r=t.createElement("cite")
return r.setAttribute("tabindex","0"),r.setAttribute("aria-label","Posted by:"),r.innerHTML=""===a.name?"Anonymous":a.name,s.appendChild(r),s.appendChild(e.Babble.createMessageTimeHTML(a)),e.Babble.gravatar===a.url&&s.appendChild(e.Babble.createDeleteButtonHTML(a)),s},createDeleteButtonHTML:function(e){var a=t.createElement("button")
return a.classList.add("Chat-msg-delete"),a.setAttribute("type","submit"),a.setAttribute("tabindex","0"),a.setAttribute("aria-label","Delete this message"),a.onclick=b,a},createParagraphHTML:function(e){var a=t.createTextNode(e.message),s=t.createElement("p")
return s.setAttribute("tabindex","0"),s.appendChild(a),s},createArticleHTML:function(a){var s=t.createElement("article")
return s.classList.add("Chat-msg-text"),s.setAttribute("tabindex","-1"),s.appendChild(e.Babble.createHeaderHTML(a)),s.appendChild(e.Babble.createParagraphHTML(a)),s},updateStats:function(e){t.querySelector(".msgsCount").textContent=e.messages.toString(),t.querySelector(".usersCount").textContent=e.users.toString()},updateKeyInLocalStorage:function(t,a){if("allKeys"===t)return void e.Babble.storage.setItem("babble",JSON.stringify({currentMessage:a,userInfo:{name:a,email:a}}))
var s=JSON.parse(e.Babble.storage.getItem("babble"))
return"userInfo"===t?(s.userInfo.name=a.name,s.userInfo.email=a.email,void e.Babble.storage.setItem("babble",JSON.stringify(s))):"currentMessage"===t?(s.currentMessage=a,void e.Babble.storage.setItem("babble",JSON.stringify(s))):void 0}},e.Babble.run(t,e,a)}(this.window,this.document,this.console,this.localStorage,this.XMLHttpRequest,this.Promise,this.navigator)
