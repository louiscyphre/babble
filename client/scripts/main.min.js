!function(e,t,s,n,a,r,o){"use strict"
e.Babble={counter:0,apiUrl:"http://localhost:9000/",messages:[],myMessagesIds:[],stats:{users:0,messages:0},storage:n,run:function(e,t,s){t.Babble.updateKey("all",""),t.Babble.getStats(t.Babble.updateStats),e.querySelector(".Chat-msgForm").addEventListener("submit",function(s){s.preventDefault()
var n=JSON.parse(t.Babble.storage.getItem("babble")),a=e.querySelector(".Chat-msgFormText"),r={name:n.userInfo.name,email:n.userInfo.email,message:a.value,timestamp:t.Date.now()}
t.Babble.postMessage(r,t.Babble.storeId)})
var n=e.querySelector(".Modal")
n.addEventListener("submit",function(e){e.preventDefault(),t.Babble.register({name:n.elements[0].value,email:n.elements[1].value}),n.style.display="none",n.style.visibility="hidden",n.setAttribute("aria-hidden","true")}),t.onbeforeunload=function(){var e=JSON.parse(t.Babble.storage.getItem("babble")).userInfo
t.Babble.request("POST","logout",e).then(function(e){s.log("Answer on POST /logout:",e),t.Babble.updateKey("all","")}).catch(function(e){s.log(e)})}},poll:function t(n,r){var o=new a
o.onload=function(){o.status>=200&&o.status<400?(s.log("Poll response from server:",o.responseText),""!==o.responseText&&r(JSON.parse(o.responseText)),t(n,r)):s.log("Server error")},o.onerror=function(){s.log("Network error")}
var l
l="messages?counter="===n?e.Babble.apiUrl+n+e.Babble.counter.toString():e.Babble.apiUrl+n,o.open("GET",l,!0),o.setRequestHeader("Content-Type","text/plain"),s.log("poll URL:",l),o.send()},register:function(t){e.Babble.updateKey("userInfo",t),e.Babble.request("POST","login",t).then(function(t){e.Babble.getMessages(e.Babble.counter,e.Babble.storeMessages)}).catch(function(e){s.log(e)})},postMessage:function(t,n){n({id:"42"}),e.Babble.updateKey("currentMessage",t.message),e.Babble.request("POST","messages",t).then(function(e){n(e)}).catch(function(e){s.log(e)})},getMessages:function(t,s){s([]),e.Babble.poll("messages?counter=",s)},deleteMessage:function(t,n){n&&n(!0)
var a="messages/"+t.toString()
e.Babble.request("DELETE",a).then(function(e){n(e)}).catch(function(e){s.log(e)})},getStats:function(t){t({users:5,messages:20}),e.Babble.poll("stats",t)},request:function(t,n,o){return new r(function(r,l){var i=new a
i.onload=function(){i.status>=200&&i.status<400?r(JSON.parse(i.responseText)):(s.log("Server error"),l(JSON.parse(i.responseText)))},i.onerror=function(){s.log("Network error")},i.open(t,e.Babble.apiUrl+n,!0),i.setRequestHeader("Content-Type","text/plain"),s.log("request: URL:",e.Babble.apiUrl+n),"POST"===t?(s.log("POSTing: ",JSON.stringify(o)),i.send(JSON.stringify(o))):i.send()})},storeMessages:function(t){e.Babble.messages=e.Babble.messages.concat(t),e.Babble.counter=e.Babble.messages.length,s.log("Messages on client:",e.Babble.messages)},createHTMLPost:function(e,s){var n=e.cloneNode(!0)
"none"!==s.url&&n.firstChild.setAttribute("src",s.url)
var a=n.firstChild.nextSibling,r=a.firstChild.firstChild
r.innerHTML=""===s.name?"Anonymous":s.name
var o=new Date(1e3*parseInt(s.timestamp)),l=o.getHours(),i="0"+o.getMinutes(),u=l+":"+i.substr(-2),b=r.nextSibling
b.setAttribute("datetime",o.toISOString()),b.innerHTML=u
var g=t.createTextNode(s.message)
return a.firstChild.nextSibling.innerHTML=g,n},updateStats:function(e){},storeId:function(e){},updateKey:function(t,s){if("all"===t)return void e.Babble.storage.setItem("babble",JSON.stringify({currentMessage:s,userInfo:{name:s,email:s}}))
var n=JSON.parse(e.Babble.storage.getItem("babble"))
if("userInfo"===t)return n.userInfo.name=s.name,n.userInfo.email=s.email,void e.Babble.storage.setItem("babble",JSON.stringify(n))
if("currentMessage"===t)return n.currentMessage=s,void e.Babble.storage.setItem("babble",JSON.stringify(n))
throw new e.Babble.exception("wrong use of updateKey()")},exception:function(e){s.error("[CRITICAL ERROR] Exception thrown: ",e)}},e.Babble.run(t,e,s)}(this.window,this.document,this.console,this.localStorage,this.XMLHttpRequest,this.Promise,this.navigator)
